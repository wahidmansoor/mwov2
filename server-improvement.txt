1. Server Foundation Cleanup

Entrypoint Unification

Delete index.js.

Use only index.ts as the main entrypoint.

Centralize route imports in routes/index.ts.

Middleware Setup

Add:

helmet â†’ security headers

cors â†’ controlled cross-origin

compression â†’ reduce payloads

pino-http â†’ structured logs with request IDs

Error Handling

app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).json({
    error: "Internal server error",
    details: process.env.NODE_ENV === "development" ? err.message : undefined
  });
});

2. Folder Structure
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Entrypoint
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ index.ts            # Central route loader
â”‚   â”‚   â”œâ”€â”€ calculators.ts      # Calculator endpoints
â”‚   â”‚   â”œâ”€â”€ protocols.ts        # Symptom/Emergency protocols
â”‚   â”‚   â”œâ”€â”€ ai.ts               # AI service endpoints
â”‚   â”‚   â”œâ”€â”€ analytics.ts        # Usage logging + reports
â”‚   â”‚   â””â”€â”€ health.ts           # Health check
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ calculators.ts
â”‚   â”‚   â”œâ”€â”€ protocols.ts
â”‚   â”‚   â”œâ”€â”€ ai.ts
â”‚   â”‚   â””â”€â”€ analytics.ts
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ calculatorService.ts
â”‚   â”‚   â”œâ”€â”€ protocolService.ts
â”‚   â”‚   â”œâ”€â”€ aiService.ts
â”‚   â”‚   â””â”€â”€ analyticsService.ts
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema.ts           # Drizzle ORM schema
â”‚   â”‚   â”œâ”€â”€ migrations/         # SQL migrations
â”‚   â”‚   â””â”€â”€ client.ts           # Supabase connection
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.ts           # Pino logger setup
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts     # Central error utilities
â”‚   â”‚   â””â”€â”€ validation.ts       # Zod schemas
â”‚   â””â”€â”€ tests/                  # Vitest + Supertest
â”‚       â”œâ”€â”€ calculators.test.ts
â”‚       â”œâ”€â”€ protocols.test.ts
â”‚       â””â”€â”€ ai.test.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json

3. Database & ORM

Use Drizzle ORM + Supabase.

Tables to deploy (non-EHR only):

symptom_protocols

emergency_guidelines

calculators

education_content

analytics_usage

Example migration:

create table calculators (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  type text not null,
  formula jsonb not null,
  created_at timestamptz default now()
);


Add Zod validation for inputs before inserts.

4. API Endpoints
ðŸ”¢ Calculators

POST /calculator/opioid-conversion

POST /calculator/renal-dose-adjustment

POST /calculator/prognostic-index

Logic in service (calculatorService.ts)

Validation with Zod:

const schema = z.object({
  drug: z.string(),
  dose: z.number().positive(),
  target: z.string()
});

ðŸ“š Protocols

GET /protocols/symptoms/:slug

GET /protocols/emergencies/:slug

Returns:

{
  "title": "Cancer Pain",
  "summary": "WHO ladder",
  "steps": ["Step 1: Non-opioid", "Step 2: Weak opioid", "Step 3: Strong opioid"],
  "red_flags": ["Uncontrolled breakthrough pain"]
}

ðŸ¤– AI Services

POST /ai/summarize-protocol

POST /ai/explain-education

POST /ai/compare-guidelines

Server does:

Inject protocol data (RAG)

Pass to LLM

Filter output (disclaimer, remove hallucinations)

ðŸ“Š Analytics

POST /analytics/log

{ "module": "calculator", "action": "opioid-conversion" }


GET /analytics/summary

{ "calculator": 320, "protocols": 120, "education": 95 }

â¤ï¸ Health

GET /healthz

{ "status": "ok", "uptime": 12345 }

5. Content Preprocessing

Job to pre-compute summaries & cache.

Store in DB for fast retrieval.

Example symptom_protocols.summary_json:

{
  "summary": "Stepwise cancer pain approach",
  "key_points": ["Non-opioids first", "Titrate opioids", "Adjuvants if needed"]
}

6. Testing

Unit (Vitest) â†’ calculators, protocol formatting, AI sanitization.

Integration (Supertest) â†’ test REST endpoints.

Example:

it("should convert morphine to oxycodone", async () => {
  const res = await request(app)
    .post("/calculator/opioid-conversion")
    .send({ drug: "morphine", dose: 30, target: "oxycodone" });
  expect(res.status).toBe(200);
  expect(res.body.equivalent_dose).toBe(20);
});

7. Documentation

Add Swagger/OpenAPI.

Example contract (YAML):

/calculator/opioid-conversion:
  post:
    description: Convert opioid dose
    requestBody:
      content:
        application/json:
          example:
            drug: "morphine"
            dose: 30
            target: "oxycodone"
    responses:
      "200":
        description: Equivalent dose
        content:
          application/json:
            example:
              equivalent_dose: 20


Generate TS SDK for client â†’ type-safe API calls.

8. Performance

Add caching (e.g., Redis layer or Supabase materialized views).

Cache protocol summaries + AI quick refs.

Use etag or last-modified headers for client caching.

Enable gzip/brotli compression.

9. Roadmap
Week 1

Entrypoint cleanup

Migrations deployed

Error middleware + logger added

Week 2

Implement calculators + protocols endpoints

Connect Supabase + Zod validation

Add /healthz

Week 3

AI endpoints live (summarize, explain, compare)

Caching enabled

Analytics logging

Week 4

Swagger docs + TS SDK

Unit + integration tests

Performance tuning